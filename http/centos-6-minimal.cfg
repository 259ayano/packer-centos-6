install
cmdline
skipx
cdrom

authconfig --enableshadow --passalgo=sha512
bootloader --location=mbr
firewall --enabled --service=ssh
network --onboot=yes --device=eth0 --bootproto=dhcp --noipv6 --hostname=localhost.localdomain
selinux --permissive

%include /tmp/lang.inc
%include /tmp/keyboard.inc
%include /tmp/timezone.inc
%include /tmp/rootpw.inc
%include /tmp/partitions.inc
%include /tmp/end.inc

%pre

get_boot_parameter ()
{
  local KEY="${1}"
  local DEFAULT="${2}"
  local VALUE="${DEFAULT}"

  if grep -Eiq "${KEY}=[^ ]" /proc/cmdline; then
    VALUE=$(
      /bin/sed "s~.*${KEY}=\([^ ]*\).*~\1~" \
      /proc/cmdline
    )
  fi

  printf -- "${VALUE}"
}

BOOT_TIMEOUT=$(
  get_boot_parameter BOOT_TIMEOUT 5
)

FSTYPE_BOOT=$(
  get_boot_parameter FSTYPE_BOOT ext4
)

FSTYPE_ROOT=$(
  get_boot_parameter FSTYPE_ROOT ext4
)

KEYTABLE=$(
  get_boot_parameter KEYTABLE us
)

LANG=$(
  get_boot_parameter LANG en_US.UTF-8
)

LV_ROOT_SIZE_MIN=$(
  get_boot_parameter LV_ROOT_SIZE_MIN 1024
)

LV_SWAP_SIZE=$(
  get_boot_parameter LV_SWAP_SIZE 512
)

PART_BOOT_SIZE=$(
  get_boot_parameter PART_BOOT_SIZE 250
)

ROOTPW=$(
  get_boot_parameter ROOTPW centos
)

TIMEZONE=$(
  get_boot_parameter TIMEZONE Etc/UTC
)

cat > /tmp/boot-timeout.inc <<-EOF
# Timout for bootloader defaults to 5 seconds - reduce for virtual guests.
/bin/sed -i \
  -e 's~^timeout=.*$~timeout=${BOOT_TIMEOUT}~g' \
  /etc/grub.conf \
  /boot/grub/grub.conf
EOF

cat > /tmp/end.inc <<-EOF
reboot
EOF

cat > /tmp/keyboard.inc <<-EOF
keyboard ${KEYTABLE}
EOF

cat > /tmp/lang.inc <<-EOF
lang ${LANG}
EOF

cat > /tmp/rootpw.inc <<-EOF
rootpw ${ROOTPW}
EOF

cat > /tmp/timezone.inc <<-EOF
timezone ${TIMEZONE} --utc
EOF

cat > /tmp/packages.inc <<-EOF
@core --nodefaults
nfs-utils
EOF

cat > /tmp/packages-exclude.inc <<-EOF
-aic94xx-firmware
-atmel-firmware
-b43-openfwwf
-bfa-firmware
-efibootmgr
# -grub
-ipw2100-firmware
-ipw2200-firmware
-ivtv-firmware
-iwl100-firmware
-iwl1000-firmware
-iwl3945-firmware
-iwl4965-firmware
-iwl5000-firmware
-iwl5150-firmware
-iwl6000-firmware
-iwl6000g2a-firmware
-iwl6050-firmware
# -kernel-firmware
-kexec-tools
-libertas-usb8388-firmware
-netxen-firmware
# -postfix
-ql2100-firmware
-ql2200-firmware
-ql23xx-firmware
-ql2400-firmware
-ql2500-firmware
-rdma
-rt61pci-firmware
-rt73usb-firmware
-xorg-x11-drv-ati-firmware
-zd1211-firmware
EOF

cat > /tmp/partitions.inc <<-EOF
zerombr

clearpart --all --initlabel
part /boot --size=${PART_BOOT_SIZE} --fstype=${FSTYPE_BOOT}
part pv.01 --size=1 --fstype=lvmpv --grow

volgroup vg_root --pesize=32768 pv.01
logvol swap --vgname=vg_root --size=${LV_SWAP_SIZE} --name=lv_swap --fstype=swap
logvol / --vgname=vg_root --size=${LV_ROOT_SIZE_MIN} --name=lv_root --fstype=${FSTYPE_ROOT} --grow
EOF

cat > /tmp/trim-locale-archive.inc <<-EOF
# Remove compiled locale resources for unused languages.
/usr/bin/localedef --list-archive | \
  /bin/grep -E -v "^(en_US|${LANG%%.*})" | \
  /usr/bin/xargs /usr/bin/localedef --delete-from-archive

/bin/mv /usr/lib/locale/locale-archive /usr/lib/locale/locale-archive.tmpl
/usr/sbin/build-locale-archive
/usr/bin/truncate -s 0 /usr/lib/locale/locale-archive.tmpl
EOF

cat > /tmp/trim-locale-definitions.inc <<-EOF
# Remove locale (internationalisation) files for unused languages.
/bin/find /usr/share/i18n/locales \
  -type f \
  -regextype posix-extended \
  \( ! -regex ".*\/(en_US|${LANG%%.*})(@.+)?$" \
    -a -regex '.*\/[a-z][a-z]([a-z])?_[A-Z][A-Z](@.+)?$' \) \
  -delete
EOF

cat > /tmp/trim-locale-translations.inc <<-EOF
# Remove locale (translation) files for unused languages.
/bin/find /usr/share/locale \
  -mindepth 1 \
  -maxdepth 1 \
  -type d \
  -regextype posix-extended \
  ! -regex ".*\/(en|en_US|${LANG%%_*}|${LANG%%.*})(@.+)?$" \
  -exec /bin/find -- {} -type f -name *.mo -delete \;
EOF
%end

%packages --nobase --nocore --ignoremissing --excludedocs
%include /tmp/packages.inc
%include /tmp/packages-exclude.inc
%end

%post
# Reduce the size of the initramfs image
/sbin/dracut -f -H

%include /tmp/boot-timeout.inc
%include /tmp/trim-locale-archive.inc
%include /tmp/trim-locale-translations.inc
%include /tmp/trim-locale-definitions.inc
%end